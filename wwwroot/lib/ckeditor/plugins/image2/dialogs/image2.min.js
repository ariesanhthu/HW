CKEDITOR.dialog.add("image2",function(a){function t(){var t=this.getValue().match(k);return(t=!(!t||0===parseInt(t[1],10)))||alert(D.invalidLength.replace("%1",D[this.id]).replace("%2","px")),t}function e(){var t=this.getValue();o(!1),t!==s.data.src?(d(t,function(t,e,i){if(o(!0),!t)return n(!1);v.setValue(!1===a.config.image2_prefillDimensions?0:e),y.setValue(!1===a.config.image2_prefillDimensions?0:i),c=u=e,h=r=i,n(_.checkHasNaturalRatio(t))}),p=!0):p?(o(!0),v.setValue(u),y.setValue(r),p=!1):o(!0)}function i(){var t,e,i,a;g&&(a=this.getValue())&&(a.match(k)||n(!1),"0"!==a)&&(t="width"==this.id,e=u||c,i=r||h,a=t?Math.round(a/e*i):Math.round(a/i*e),isNaN(a)||(t?y:v).setValue(a))}function n(t){if(m){if("boolean"==typeof t){if(f)return;g=t}else t=v.getValue(),f=!0,(g=!g)&&t&&(t*=r/u,isNaN(t)||y.setValue(Math.round(t)));m[g?"removeClass":"addClass"]("cke_btn_unlocked"),m.setAttribute("aria-checked",g),CKEDITOR.env.hc&&m.getChild(0).setHtml(g?CKEDITOR.env.ie?"■":"▣":CKEDITOR.env.ie?"□":"▢")}}function o(t){v[t=t?"enable":"disable"](),y[t]()}var l,s,d,u,r,c,h,p,g,f,m,b,v,y,V,k=/(^\s*(\d+)(px)?\s*$)|^$/i,C=CKEDITOR.tools.getNextId(),w=CKEDITOR.tools.getNextId(),x=a.lang.image2,D=a.lang.common,I=new CKEDITOR.template('<div><a href="javascript:void(0)" tabindex="-1" title="'+x.lockRatio+'" class="cke_btn_locked" id="{lockButtonId}" role="checkbox"><span class="cke_icon"></span><span class="cke_label">'+x.lockRatio+'</span></a><a href="javascript:void(0)" tabindex="-1" title="'+x.resetSize+'" class="cke_btn_reset" id="{resetButtonId}" role="button"><span class="cke_label">'+x.resetSize+"</span></a></div>").output({lockButtonId:C,resetButtonId:w}),_=CKEDITOR.plugins.image2,R=a.config,E=!(!R.filebrowserImageBrowseUrl&&!R.filebrowserBrowseUrl),K=a.widgets.registered.image.features,T=_.getNatural,B=[{id:"src",type:"text",label:D.url,onKeyup:e,onChange:e,setup:function(t){this.setValue(t.data.src)},commit:function(t){t.setData("src",this.getValue())},validate:CKEDITOR.dialog.validate.notEmpty(x.urlMissing)}];return E&&B.push({type:"button",id:"browse",style:"display:inline-block;margin-top:14px;",align:"center",label:a.lang.common.browseServer,hidden:!0,filebrowser:"info:src"}),{title:x.title,minWidth:250,minHeight:100,onLoad:function(){function n(t,i){a.push(o.once(t,function(t){for(var e;e=a.pop();)e.removeListener();i(t)}))}var o,a;l=this._.element.getDocument(),o=l.createElement("img"),a=[],d=function(t,e,i){n("load",function(){var t=T(o);e.call(i,o,t.width,t.height)}),n("error",function(){e(null)}),n("abort",function(){e(null)});var a=-1!==t.indexOf("?")?"&":"?";o.setAttribute("src",(R.baseHref||"")+t+a+Math.random().toString(16).substring(2))}},onShow:function(){s=this.getModel(),V=s.parts.image,p=f=g=!1,V=T(V),c=u=V.width,h=r=V.height},contents:[{id:"info",label:x.infoTab,elements:[{type:"vbox",padding:0,children:[{type:"hbox",widths:["100%"],className:"cke_dialog_image_url",children:B}]},{id:"alt",type:"text",label:x.alt,setup:function(t){this.setValue(t.data.alt)},commit:function(t){t.setData("alt",this.getValue())},validate:!0===a.config.image2_altRequired?CKEDITOR.dialog.validate.notEmpty(x.altMissing):null},{type:"hbox",widths:["25%","25%","50%"],requiredContent:K.dimension.requiredContent,children:[{type:"text",width:"45px",id:"width",label:D.width,validate:t,onKeyUp:i,onLoad:function(){v=this},setup:function(t){this.setValue(t.data.width)},commit:function(t){t.setData("width",this.getValue())}},{type:"text",id:"height",width:"45px",label:D.height,validate:t,onKeyUp:i,onLoad:function(){y=this},setup:function(t){this.setValue(t.data.height)},commit:function(t){t.setData("height",this.getValue())}},{id:"lock",type:"html",style:"margin-top:18px;width:40px;height:20px;",onLoad:function(){function t(t){t.on("mouseover",function(){this.addClass("cke_btn_over")},t),t.on("mouseout",function(){this.removeClass("cke_btn_over")},t)}var e=this.getDialog();m=l.getById(C),b=l.getById(w),m&&(e.addFocusable(m,4+E),m.on("click",function(t){n(),t.data&&t.data.preventDefault()},this.getDialog()),t(m)),b&&(e.addFocusable(b,5+E),b.on("click",function(t){p?(v.setValue(c),y.setValue(h)):(v.setValue(u),y.setValue(r)),t.data&&t.data.preventDefault()},this),t(b))},setup:function(t){n(t.data.lock)},commit:function(t){t.setData("lock",g)},html:I}]},{type:"hbox",id:"alignment",requiredContent:K.align.requiredContent,children:[{id:"align",type:"radio",items:[[D.alignNone,"none"],[D.left,"left"],[D.center,"center"],[D.right,"right"]],label:D.align,setup:function(t){this.setValue(t.data.align)},commit:function(t){t.setData("align",this.getValue())}}]},{id:"hasCaption",type:"checkbox",label:x.captioned,requiredContent:K.caption.requiredContent,setup:function(t){this.setValue(t.data.hasCaption)},commit:function(t){t.setData("hasCaption",this.getValue())}}]},{id:"Upload",hidden:!0,filebrowser:"uploadButton",label:x.uploadTab,elements:[{type:"file",id:"upload",label:x.btnUpload,style:"height:40px"},{type:"fileButton",id:"uploadButton",filebrowser:"info:src",label:x.btnUpload,for:["Upload","upload"]}]}]}});